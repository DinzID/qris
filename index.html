<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeShare - Berbagi Kode dengan Mudah</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Highlight.js untuk syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/vs2015.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #FF7B00;
            --secondary-color: #FFAA33;
            --accent-color: #FF5500;
            --dark-bg: #1A1A2E;
            --dark-card: #252947;
            --dark-text: #FFFFFF;
            --light-bg: #F0F0F0;
            --light-card: #FFFFFF;
            --light-text: #333333;
            --skin-color: #FFD6B8;
            --comic-border: #FF7B00;
            --error-color: #FF3333;
            --success-color: #00CC66;
            --warning-color: #FFAA00;
            --info-color: #3399FF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: all 0.3s ease;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--dark-text);
            min-height: 100vh;
            padding-bottom: 80px;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255, 123, 0, 0.1) 2px, transparent 2px),
                radial-gradient(circle at 75% 75%, rgba(255, 170, 51, 0.1) 2px, transparent 2px);
            background-size: 30px 30px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Header Styles */
        header {
            background-color: var(--dark-card);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--comic-border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.2);
        }

        .logo i {
            font-size: 2rem;
        }

        .nav-desktop {
            display: none;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        /* Button Styles */
        button {
            cursor: pointer;
            border: none;
            border-radius: 8px;
            padding: 12px 18px;
            font-weight: 500;
            transition: all 0.3s;
            font-family: 'Roboto', sans-serif;
            position: relative;
            overflow: hidden;
        }

        button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 0 rgba(179, 85, 0, 0.8);
        }

        .btn-primary:hover {
            background-color: #FF6A00;
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(179, 85, 0, 0.8);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
            box-shadow: 0 4px 0 rgba(179, 119, 0, 0.8);
        }

        .btn-secondary:hover {
            background-color: #FF9900;
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(179, 119, 0, 0.8);
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            box-shadow: 0 4px 0 rgba(255, 123, 0, 0.3);
        }

        .btn-outline:hover {
            background-color: rgba(255, 123, 0, 0.1);
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(255, 123, 0, 0.3);
        }

        .btn-danger {
            background-color: var(--error-color);
            color: white;
            box-shadow: 0 4px 0 rgba(179, 0, 0, 0.8);
        }

        .btn-danger:hover {
            background-color: #FF1111;
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(179, 0, 0, 0.8);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--secondary-color);
        }

        input, textarea, select {
            width: 100%;
            padding: 14px;
            border-radius: 8px;
            border: 2px solid var(--dark-card);
            background-color: var(--dark-card);
            color: var(--dark-text);
            font-family: 'Roboto', sans-serif;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 123, 0, 0.3);
        }

        /* Card Styles */
        .card {
            background-color: var(--dark-card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            border: 2px solid var(--comic-border);
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: 1px solid rgba(255, 123, 0, 0.3);
            border-radius: 8px;
            pointer-events: none;
        }

        /* Page Styles */
        .page {
            display: none;
            padding: 24px 0;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page.active {
            display: block;
        }

        /* Auth Page */
        .auth-container {
            max-width: 400px;
            margin: 40px auto;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--dark-card);
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 16px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: var(--dark-text);
        }

        .auth-tab.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
        }

        .auth-providers {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }

        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 24px 0;
            color: var(--secondary-color);
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 2px solid var(--dark-card);
        }

        .divider span {
            padding: 0 12px;
        }

        /* Home Page */
        .share-button-container {
            text-align: center;
            margin: 24px 0;
        }

        .code-feed {
            margin-top: 24px;
        }

        .code-card {
            margin-bottom: 24px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .code-card:hover {
            transform: translateY(-5px);
        }

        .code-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
            border: 2px solid var(--primary-color);
        }

        .user-info {
            flex: 1;
        }

        .username {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--dark-text);
        }

        .verified-badge {
            color: var(--primary-color);
            font-size: 0.9rem;
        }

        .code-language {
            background-color: var(--primary-color);
            color: white;
            padding: 4px 10px;
            border-radius: 14px;
            font-size: 0.8rem;
            display: inline-block;
            margin-top: 4px;
        }

        .code-preview {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 16px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--comic-border);
        }

        .code-preview pre {
            margin: 0;
            overflow: hidden;
            max-height: 150px;
            mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
        }

        .code-stats {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            color: var(--secondary-color);
            font-size: 0.9rem;
        }

        .code-stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Share Code Page */
        .code-editor-container {
            margin-bottom: 24px;
        }

        .code-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        #code-editor {
            width: 100%;
            min-height: 300px;
            font-family: 'Courier New', monospace;
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
            resize: vertical;
            border: 2px solid var(--comic-border);
        }

        .code-preview-container {
            margin-top: 24px;
        }

        /* View Code Page */
        .view-code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .code-container {
            position: relative;
            border: 2px solid var(--comic-border);
            border-radius: 8px;
            overflow: hidden;
        }

        .copy-button {
            position: absolute;
            top: 12px;
            right: 12px;
            background-color: rgba(30, 30, 30, 0.8);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 14px;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Profile Page */
        .profile-header {
            position: relative;
            margin-bottom: 70px;
        }

        .profile-banner {
            height: 180px;
            background-color: var(--primary-color);
            border-radius: 12px 12px 0 0;
            position: relative;
            background-size: cover;
            background-position: center;
            border: 2px solid var(--comic-border);
            border-bottom: none;
        }

        .profile-avatar-container {
            position: absolute;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--dark-card);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            background-color: var(--dark-card);
        }

        .profile-content {
            padding: 0 20px 20px;
            text-align: center;
        }

        .profile-info {
            margin-top: 60px;
        }

        .profile-name {
            font-size: 1.6rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .profile-bio {
            margin: 16px 0;
            color: var(--secondary-color);
            font-style: italic;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.5;
        }

        .profile-stats {
            display: flex;
            gap: 24px;
            justify-content: center;
            margin: 20px 0;
        }

        .profile-stat {
            text-align: center;
            padding: 16px;
            background-color: rgba(255, 123, 0, 0.1);
            border-radius: 12px;
            min-width: 120px;
            border: 1px solid var(--comic-border);
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--secondary-color);
            margin-top: 4px;
        }

        .profile-codes {
            margin-top: 32px;
        }

        /* Edit Profile Page */
        .image-upload-container {
            margin-bottom: 24px;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 12px;
            margin-top: 12px;
            border: 2px solid var(--comic-border);
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin-top: 12px;
            border: 2px solid var(--comic-border);
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .upload-progress {
            margin-top: 12px;
            background-color: var(--dark-bg);
            border-radius: 8px;
            height: 20px;
            overflow: hidden;
            display: none;
            border: 1px solid var(--comic-border);
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s;
        }

        /* Upload Button Styles */
        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            margin-top: 10px;
            width: 100%;
        }

        .upload-btn-wrapper .btn-outline {
            width: 100%;
            text-align: center;
        }

        .upload-btn-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* GitHub Config Section */
        .github-config {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .github-config h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .github-config p {
            margin-bottom: 8px;
            color: var(--secondary-color);
        }

        /* Leaderboard Page */
        .leaderboard-list {
            margin-top: 24px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 2px solid var(--dark-bg);
            transition: background-color 0.3s;
        }

        .leaderboard-item:hover {
            background-color: rgba(255, 123, 0, 0.05);
        }

        .leaderboard-rank {
            font-size: 1.3rem;
            font-weight: bold;
            width: 50px;
            text-align: center;
            color: var(--primary-color);
        }

        .leaderboard-user {
            display: flex;
            align-items: center;
            flex: 1;
            gap: 12px;
        }

        .leaderboard-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }

        .leaderboard-value {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--dark-card);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border-top: 2px solid var(--comic-border);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--secondary-color);
            text-decoration: none;
            font-size: 0.8rem;
            padding: 8px;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .nav-item.active {
            color: var(--primary-color);
            background-color: rgba(255, 123, 0, 0.1);
        }

        .nav-item i {
            font-size: 1.4rem;
            margin-bottom: 4px;
        }

        /* Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .notification {
            background-color: var(--dark-card);
            color: var(--dark-text);
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s forwards, fadeOut 0.5s forwards 2.5s;
            max-width: 350px;
            border-left: 4px solid var(--info-color);
        }

        .notification.success {
            border-left-color: var(--success-color);
        }

        .notification.error {
            border-left-color: var(--error-color);
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        .notification.info {
            border-left-color: var(--info-color);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* Loading Spinner */
        .spinner {
            width: 28px;
            height: 28px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
            margin: 20px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Admin Badge */
        .admin-badge {
            background-color: var(--error-color);
            color: white;
            padding: 3px 10px;
            border-radius: 14px;
            font-size: 0.7rem;
            margin-left: 6px;
        }

        .verified-badge {
            background-color: var(--success-color);
            color: white;
            padding: 3px 8px;
            border-radius: 14px;
            font-size: 0.7rem;
            margin-left: 6px;
        }

        /* Search Page */
        .search-container {
            margin-bottom: 24px;
        }

        .search-results {
            margin-top: 24px;
        }

        /* Admin Page */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .admin-stat-card {
            background-color: var(--dark-card);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid var(--comic-border);
        }

        .admin-stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .admin-stat-label {
            color: var(--secondary-color);
            font-size: 0.9rem;
        }

        /* Pagination Styles */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination-btn {
            padding: 8px 16px;
            border-radius: 8px;
            background-color: var(--dark-card);
            color: var(--dark-text);
            border: 1px solid var(--comic-border);
            cursor: pointer;
        }

        .pagination-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .pagination-btn:hover:not(.active) {
            background-color: rgba(255, 123, 0, 0.2);
        }

        /* Share Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            display: none;
        }

        .modal {
            background-color: var(--dark-card);
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            border: 2px solid var(--comic-border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--dark-text);
            font-size: 24px;
            cursor: pointer;
        }

        .share-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(255, 123, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .share-option:hover {
            background-color: rgba(255, 123, 0, 0.2);
            transform: translateY(-3px);
        }

        .share-option i {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .share-link {
            display: flex;
            align-items: center;
            margin-top: 20px;
            background-color: var(--dark-bg);
            padding: 10px;
            border-radius: 8px;
        }

        .share-link input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--dark-text);
        }

        .copy-link-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Responsive Styles */
        @media (min-width: 768px) {
            .nav-desktop {
                display: flex;
                gap: 24px;
            }
            
            .nav-item-desktop {
                color: var(--dark-text);
                text-decoration: none;
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 8px 16px;
                border-radius: 8px;
                transition: background-color 0.3s;
            }
            
            .nav-item-desktop:hover {
                background-color: rgba(255, 123, 0, 0.1);
            }
            
            .nav-item-desktop.active {
                color: var(--primary-color);
                background-color: rgba(255, 123, 0, 0.1);
            }
            
            .bottom-nav {
                display: none;
            }
            
            body {
                padding-bottom: 0;
            }

            .profile-stats {
                gap: 30px;
            }

            .profile-stat {
                min-width: 140px;
            }
        }

        /* Pixel art elements */
        .pixel-divider {
            height: 4px;
            background-image: 
                linear-gradient(90deg, 
                    transparent 0%, 
                    var(--primary-color) 20%, 
                    var(--secondary-color) 40%, 
                    var(--primary-color) 60%, 
                    var(--secondary-color) 80%, 
                    transparent 100%);
            margin: 20px 0;
            image-rendering: pixelated;
        }

        .comic-button {
            position: relative;
            border: 2px solid #000;
            box-shadow: 4px 4px 0 #000;
            transition: all 0.1s ease;
        }

        .comic-button:hover {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #000;
        }
        
        .page-info {
    padding: 8px 16px;
    margin: 0 10px;
    background-color: var(--dark-card);
    border-radius: 8px;
    color: var(--dark-text);
    border: 1px solid var(--comic-border);
}
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div class="notification-container" id="notification-container"></div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="share-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Bagikan Kode</h3>
                <button class="modal-close" id="close-share-modal">&times;</button>
            </div>
            <div class="share-options">
                <div class="share-option" data-platform="facebook">
                    <i class="fab fa-facebook"></i>
                    <span>Facebook</span>
                </div>
                <div class="share-option" data-platform="twitter">
                    <i class="fab fa-twitter"></i>
                    <span>Twitter</span>
                </div>
                <div class="share-option" data-platform="whatsapp">
                    <i class="fab fa-whatsapp"></i>
                    <span>WhatsApp</span>
                </div>
                <div class="share-option" data-platform="telegram">
                    <i class="fab fa-telegram"></i>
                    <span>Telegram</span>
                </div>
                <div class="share-option" data-platform="linkedin">
                    <i class="fab fa-linkedin"></i>
                    <span>LinkedIn</span>
                </div>
                <div class="share-option" data-platform="copy">
                    <i class="fas fa-copy"></i>
                    <span>Salin Link</span>
                </div>
            </div>
            <div class="share-link">
                <input type="text" id="share-url" readonly>
                <button class="copy-link-btn" id="copy-share-url">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="container header-content">
            <div class="logo">
                <i class="material-icons">code</i>
                <span>CodeShare</span>
            </div>
            
            <nav class="nav-desktop">
                <a href="#" class="nav-item-desktop active" data-page="home">
                    <i class="material-icons">home</i>
                    <span>Beranda</span>
                </a>
                <a href="#" class="nav-item-desktop" data-page="search">
                    <i class="material-icons">search</i>
                    <span>Cari</span>
                </a>
                <a href="#" class="nav-item-desktop" data-page="leaderboard">
                    <i class="material-icons">leaderboard</i>
                    <span>Leaderboard</span>
                </a>
                <a href="#" class="nav-item-desktop" data-page="profile" id="profile-nav" style="display: none;">
                    <i class="material-icons">person</i>
                    <span>Profil</span>
                </a>
                <a href="#" class="nav-item-desktop" data-page="admin" id="admin-nav" style="display: none;">
                    <i class="material-icons">admin_panel_settings</i>
                    <span>Admin</span>
                </a>
            </nav>
            
            <div class="auth-buttons" id="auth-buttons">
                <button class="btn-outline comic-button" id="login-btn">Masuk</button>
                <button class="btn-primary comic-button" id="signup-btn">Daftar</button>
            </div>
            
            <div id="user-menu" style="display: none;">
                <button class="btn-outline comic-button" id="logout-btn">Keluar</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Auth Page -->
        <section class="page active" id="auth-page">
            <div class="auth-container">
                <div class="auth-tabs">
                    <div class="auth-tab active" id="login-tab">Masuk</div>
                    <div class="auth-tab" id="signup-tab">Daftar</div>
                </div>
                
                <div class="card">
                    <form id="auth-form">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="password">Kata Sandi</label>
                            <input type="password" id="password" required>
                        </div>
                        
                        <button type="submit" class="btn-primary comic-button" id="auth-submit">Masuk</button>
                    </form>
                    
                    <div class="divider">
                        <span>atau</span>
                    </div>
                    
                    <div class="auth-providers">
                        <button class="btn-outline comic-button" id="google-login">
                            <i class="fab fa-google"></i>
                            Masuk dengan Google
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Home Page -->
        <section class="page" id="home-page">
            <div class="share-button-container">
                <button class="btn-primary comic-button" id="share-code-btn">
                    <i class="material-icons">add</i>
                    Bagikan Kode
                </button>
            </div>
            
            <div class="code-feed" id="code-feed">
                <div class="spinner"></div>
            </div>

            <div class="pagination" id="pagination">
                <!-- Pagination buttons will be added here -->
            </div>
        </section>

        <!-- Search Page -->
        <section class="page" id="search-page">
            <div class="card search-container">
                <h2>Cari Kode</h2>
                <div class="form-group">
                    <input type="text" id="search-input" placeholder="Cari berdasarkan judul, bahasa, atau deskripsi...">
                </div>
                <button class="btn-primary comic-button" id="search-button">Cari</button>
            </div>
            
            <div class="search-results" id="search-results">
                <!-- Hasil pencarian akan ditampilkan di sini -->
            </div>
        </section>

        <!-- Share Code Page -->
        <section class="page" id="share-code-page">
            <div class="card">
                <h2>Bagikan Kode Anda</h2>
                
                <div class="form-group">
                    <label for="code-title">Judul Kode</label>
                    <input type="text" id="code-title" placeholder="Masukkan judul kode">
                </div>
                
                <div class="form-group">
                    <label for="code-description">Deskripsi</label>
                    <textarea id="code-description" rows="3" placeholder="Jelaskan tentang kode ini"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="code-language">Bahasa Pemrograman</label>
                    <select id="code-language">
                        <option value="javascript">JavaScript</option>
                        <option value="python">Python</option>
                        <option value="java">Java</option>
                        <option value="cpp">C++</option>
                        <option value="html">HTML</option>
                        <option value="css">CSS</option>
                        <option value="php">PHP</option>
                        <option value="ruby">Ruby</option>
                    </select>
                </div>
                
                <div class="code-editor-container">
                    <div class="code-editor-header">
                        <label for="code-editor">Kode</label>
                    </div>
                    <textarea id="code-editor" placeholder="Tempel kode Anda di sini"></textarea>
                </div>
                
                <button class="btn-primary comic-button" id="publish-code">Terbitkan</button>
            </div>
            
            <div class="card code-preview-container">
                <h3>Pratinjau</h3>
                <div id="code-preview">
                    <pre><code class="language-javascript">// Pratinjau kode akan muncul di sini</code></pre>
                </div>
            </div>
        </section>

        <!-- View Code Page -->
        <section class="page" id="view-code-page">
            <div class="view-code-header">
                <button class="btn-outline comic-button" id="back-button">
                    <i class="material-icons">arrow_back</i>
                    Kembali
                </button>
                <button class="btn-primary comic-button" id="share-code-button">
                    <i class="material-icons">share</i>
                    Bagikan
                </button>
            </div>
            
            <div class="card">
                <div class="code-card-header">
                    <img src="https://via.placeholder.com/40" alt="User Avatar" class="user-avatar" id="view-author-avatar">
                    <div class="user-info">
                        <div class="username">
                            <span id="view-author-name"></span>
                            <span class="verified-badge" id="view-verified-badge" style="display: none;">Terverifikasi</span>
                            <span class="admin-badge" id="view-admin-badge" style="display: none;">Admin</span>
                        </div>
                        <span class="code-language" id="view-code-language">JavaScript</span>
                    </div>
                </div>
                
                <h3 id="view-code-title"></h3>
                <p id="view-code-description"></p>
                
                <div class="code-stats">
                    <div class="code-stat">
                        <i class="material-icons">visibility</i>
                        <span id="view-code-views">0</span>
                    </div>
                    <div class="code-stat">
                        <i class="material-icons">content_copy</i>
                        <span id="view-code-copies">0</span>
                    </div>
                </div>
            </div>
            
            <div class="card code-container">
                <button class="copy-button comic-button" id="copy-code-button">
                    <i class="material-icons">content_copy</i>
                    Salin
                </button>
                <pre><code class="language-javascript" id="view-code-content"></code></pre>
            </div>
        </section>

        <!-- Profile Page -->
        <section class="page" id="profile-page">
            <div class="card">
                <div class="profile-header">
                    <div class="profile-banner" id="profile-banner"></div>
                    <div class="profile-avatar-container">
                        <img src="https://via.placeholder.com/100" alt="Profile Avatar" class="profile-avatar" id="profile-avatar">
                    </div>
                </div>
                
                <div class="profile-content">
                    <div class="profile-info">
                        <div class="profile-name">
                            <span id="profile-display-name"></span>
                            <span class="verified-badge" id="profile-verified-badge" style="display: none;">Terverifikasi</span>
                            <span class="admin-badge" id="profile-admin-badge" style="display: none;">Admin</span>
                        </div>
                        <p class="profile-bio" id="profile-bio"></p>
                        
                        <div class="profile-stats">
                            <div class="profile-stat">
                                <div class="stat-value" id="profile-codes-count">0</div>
                                <div class="stat-label">Kode Dibagikan</div>
                            </div>
                            <div class="profile-stat">
                                <div class="stat-value" id="profile-views-count">0</div>
                                <div class="stat-label">Total Dilihat</div>
                            </div>
                            <div class="profile-stat">
                                <div class="stat-value" id="profile-copies-count">0</div>
                                <div class="stat-label">Total Disalin</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="profile-codes">
                <h3>Kode yang Dibagikan</h3>
                <div id="user-codes-list">
                    <div class="spinner"></div>
                </div>
            </div>
        </section>

        <!-- Edit Profile Page -->
        <section class="page" id="edit-profile-page">
            <div class="card">
                <h2>Edit Profil</h2>
                
                <div class="form-group">
                    <label for="edit-display-name">Nama Tampilan</label>
                    <input type="text" id="edit-display-name">
                </div>
                
                <div class="form-group">
                    <label for="edit-bio">Bio</label>
                    <textarea id="edit-bio" rows="3" placeholder="Ceritakan tentang diri Anda"></textarea>
                </div>
                
                <div class="form-group image-upload-container">
                    <label>Foto Profil</label>
                    <div class="upload-btn-wrapper">
                        <button class="btn-outline comic-button">
                            <i class="material-icons">file_upload</i> Pilih Gambar
                        </button>
                        <input type="file" id="avatar-upload" accept="image/*">
                    </div>
                    <img src="https://via.placeholder.com/100" alt="Preview Avatar" class="avatar-preview" id="avatar-preview">
                    <div class="upload-progress" id="avatar-progress">
                        <div class="progress-bar" id="avatar-progress-bar"></div>
                    </div>
                </div>
                
                <div class="form-group image-upload-container">
                    <label>Banner Profil</label>
                    <div class="upload-btn-wrapper">
                        <button class="btn-outline comic-button">
                            <i class="material-icons">file_upload</i> Pilih Gambar
                        </button>
                        <input type="file" id="banner-upload" accept="image/*">
                    </div>
                    <img src="https://via.placeholder.com/800x200" alt="Preview Banner" class="image-preview" id="banner-preview">
                    <div class="upload-progress" id="banner-progress">
                        <div class="progress-bar" id="banner-progress-bar"></div>
                    </div>
                </div>
                
                <div class="github-config">
                    <h4>Konfigurasi GitHub</h4>
                    <p>Pastikan Anda sudah mengatur konfigurasi GitHub di bagian bawah kode JavaScript</p>
                    <p>Anda perlu mengganti: <strong>githubUsername</strong>, <strong>githubToken</strong>, <strong>repo</strong></p>
                </div>
                
                <button class="btn-primary comic-button" id="save-profile-btn">Simpan Perubahan</button>
            </div>
        </section>

        <!-- Leaderboard Page -->
        <section class="page" id="leaderboard-page">
            <div class="card">
                <h2>Papan Peringkat</h2>
                <p>Pengguna dengan kode terbanyak yang dibagikan</p>
                
                <div class="leaderboard-list" id="leaderboard-list">
                    <div class="spinner"></div>
                </div>
            </div>
        </section>

        <!-- Admin Page -->
        <section class="page" id="admin-page">
            <div class="card">
                <h2>Panel Admin</h2>
                
                <div class="admin-stats">
                    <div class="admin-stat-card">
                        <div class="admin-stat-label">Total Pengguna</div>
                        <div class="admin-stat-value" id="admin-total-users">0</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-label">Total Kode</div>
                        <div class="admin-stat-value" id="admin-total-codes">0</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-label">Kode Hari Ini</div>
                        <div class="admin-stat-value" id="admin-today-codes">0</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-label">Total Views</div>
                        <div class="admin-stat-value" id="admin-total-views">0</div>
                    </div>
                </div>
                
                <div class="pixel-divider"></div>
                
                <div class="form-group">
                    <label for="user-search">Cari Pengguna</label>
                    <input type="text" id="user-search" placeholder="Masukkan email atau nama pengguna">
                    <button class="btn-primary comic-button" id="search-user-btn">Cari</button>
                </div>
                
                <div id="user-search-results">
                    <!-- Hasil pencarian pengguna akan ditampilkan di sini -->
                </div>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-page="home">
            <i class="material-icons">home</i>
            <span>Beranda</span>
        </a>
        <a href="#" class="nav-item" data-page="search">
            <i class="material-icons">search</i>
            <span>Cari</span>
        </a>
        <a href="#" class="nav-item" data-page="leaderboard">
            <i class="material-icons">leaderboard</i>
            <span>Leaderboard</span>
        </a>
        <a href="#" class="nav-item" data-page="profile" id="profile-nav-mobile">
            <i class="material-icons">person</i>
            <span>Profil</span>
        </a>
    </nav>

  <script>
    // Konfigurasi Firebase - GANTI DENGAN KONFIGURASI ANDA
    const firebaseConfig = {
        apiKey: "AIzaSyATf0aEn7Kcsduk6ZnQ6tpxpMJO9HZLXOg",
        authDomain: "shareing-code.firebaseapp.com",
        projectId: "shareing-code",
        storageBucket: "shareing-code.firebasestorage.app",
        messagingSenderId: "843301763009",
        appId: "1:843301763009:web:66cf2a33d93afc8452a140"
    };

    // Konfigurasi GitHub - GANTI DENGAN KONFIGURASI ANDA
    const githubUsername = 'DinziD';
    const githubToken = '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';
    const repo = 'qris';
    const branch = 'main';
    const folderPath = 'images';

    // Daftar UID Admin - GANTI DENGAN UID ANDA
    const ADMIN_UIDS = [
        'bFyhJzrMbMdZtJkfl5sC95BNiTo2',
        'UID_ADMIN_2'
    ];

    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    // DOM Elements
    const pages = document.querySelectorAll('.page');
    const navItems = document.querySelectorAll('.nav-item, .nav-item-desktop');
    const authButtons = document.getElementById('auth-buttons');
    const userMenu = document.getElementById('user-menu');
    const loginBtn = document.getElementById('login-btn');
    const signupBtn = document.getElementById('signup-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const authForm = document.getElementById('auth-form');
    const authSubmit = document.getElementById('auth-submit');
    const loginTab = document.getElementById('login-tab');
    const signupTab = document.getElementById('signup-tab');
    const googleLoginBtn = document.getElementById('google-login');
    const shareCodeBtn = document.getElementById('share-code-btn');
    const publishCodeBtn = document.getElementById('publish-code');
    const codeEditor = document.getElementById('code-editor');
    const codePreview = document.getElementById('code-preview');
    const codeLanguage = document.getElementById('code-language');
    const backButton = document.getElementById('back-button');
    const copyCodeButton = document.getElementById('copy-code-button');
    const profileNav = document.getElementById('profile-nav');
    const profileNavMobile = document.getElementById('profile-nav-mobile');
    const saveProfileBtn = document.getElementById('save-profile-btn');
    const avatarUpload = document.getElementById('avatar-upload');
    const avatarPreview = document.getElementById('avatar-preview');
    const avatarProgress = document.getElementById('avatar-progress');
    const avatarProgressBar = document.getElementById('avatar-progress-bar');
    const bannerUpload = document.getElementById('banner-upload');
    const bannerPreview = document.getElementById('banner-preview');
    const bannerProgress = document.getElementById('banner-progress');
    const bannerProgressBar = document.getElementById('banner-progress-bar');
    const searchInput = document.getElementById('search-input');
    const searchButton = document.getElementById('search-button');
    const searchResults = document.getElementById('search-results');
    const userSearch = document.getElementById('user-search');
    const searchUserBtn = document.getElementById('search-user-btn');
    const userSearchResults = document.getElementById('user-search-results');
    const adminNav = document.getElementById('admin-nav');
    const paginationContainer = document.getElementById('pagination');
    const shareModal = document.getElementById('share-modal');
    const closeShareModal = document.getElementById('close-share-modal');
    const shareCodeButton = document.getElementById('share-code-button');
    const shareOptions = document.querySelectorAll('.share-option');
    const shareUrlInput = document.getElementById('share-url');
    const copyShareUrlBtn = document.getElementById('copy-share-url');

    // State variables
    let currentUser = null;
    let isLoginMode = true;
    let currentViewingCodeId = null;
    let adminStats = {
        totalUsers: 0,
        totalCodes: 0,
        todayCodes: 0,
        totalViews: 0
    };
    let currentPage = 1;
    const codesPerPage = 5;
    let totalCodes = 0;
    let lastVisibleDoc = null;
    let firstVisibleDoc = null;

    // Initialize the app
    function init() {
        setupEventListeners();
        checkAuthState();
        showPage('auth-page');
    }

    // Set up event listeners
    function setupEventListeners() {
        // Navigation
        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = `${item.dataset.page}-page`;
                
                if (pageId === 'leaderboard-page') {
                    loadLeaderboard();
                } else if (pageId === 'admin-page') {
                    loadAdminStats();
                }
                
                showPage(pageId);
                
                // Update active nav item
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
            });
        });

        // Auth tabs
        loginTab.addEventListener('click', () => switchAuthMode(true));
        signupTab.addEventListener('click', () => switchAuthMode(false));

        // Auth buttons
        loginBtn.addEventListener('click', () => showPage('auth-page'));
        signupBtn.addEventListener('click', () => {
            switchAuthMode(false);
            showPage('auth-page');
        });
        logoutBtn.addEventListener('click', handleLogout);

        // Auth form
        authForm.addEventListener('submit', handleAuthSubmit);
        googleLoginBtn.addEventListener('click', handleGoogleLogin);

        // Code sharing
        shareCodeBtn.addEventListener('click', () => {
            if (currentUser) {
                showPage('share-code-page');
            } else {
                showPage('auth-page');
                showNotification('Silakan masuk untuk berbagi kode', 'info');
            }
        });

        publishCodeBtn.addEventListener('click', handlePublishCode);
        codeEditor.addEventListener('input', updateCodePreview);
        codeLanguage.addEventListener('change', updateCodePreview);

        // View code
        backButton.addEventListener('click', () => showPage('home-page'));
        copyCodeButton.addEventListener('click', handleCopyCode);
        shareCodeButton.addEventListener('click', showShareModal);

        // Profile
        profileNav.addEventListener('click', (e) => {
            e.preventDefault();
            loadProfilePage(currentUser.uid);
            showPage('profile-page');
        });

        profileNavMobile.addEventListener('click', (e) => {
            e.preventDefault();
            loadProfilePage(currentUser.uid);
            showPage('profile-page');
        });

        // Edit profile
        saveProfileBtn.addEventListener('click', handleSaveProfile);
        
        // Image uploads
        avatarUpload.addEventListener('change', (e) => {
            handleImageUpload(e.target.files[0], 'avatar');
        });
        
        bannerUpload.addEventListener('change', (e) => {
            handleImageUpload(e.target.files[0], 'banner');
        });

        // Search
        searchButton.addEventListener('click', handleSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSearch();
        });

        // Admin
        searchUserBtn.addEventListener('click', handleUserSearch);

        // Share modal
        closeShareModal.addEventListener('click', () => {
            shareModal.style.display = 'none';
        });

        shareOptions.forEach(option => {
            option.addEventListener('click', (e) => {
                const platform = e.currentTarget.dataset.platform;
                shareToPlatform(platform);
            });
        });

        copyShareUrlBtn.addEventListener('click', copyShareUrl);

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === shareModal) {
                shareModal.style.display = 'none';
            }
        });
    }

    // Show a specific page
    function showPage(pageId) {
        pages.forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById(pageId).classList.add('active');
        
        // Load data jika diperlukan
        if (pageId === 'home-page') {
            loadCodeFeed();
        }
    }

    // Switch between login and signup mode
    function switchAuthMode(loginMode) {
        isLoginMode = loginMode;
        
        if (loginMode) {
            loginTab.classList.add('active');
            signupTab.classList.remove('active');
            authSubmit.textContent = 'Masuk';
            authForm.dataset.mode = 'login';
        } else {
            loginTab.classList.remove('active');
            signupTab.classList.add('active');
            authSubmit.textContent = 'Daftar';
            authForm.dataset.mode = 'signup';
        }
    }

    // Check authentication state
    // Check authentication state
// Check authentication state
function checkAuthState() {
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            authButtons.style.display = 'none';
            userMenu.style.display = 'block';
            profileNav.style.display = 'flex';
            profileNavMobile.style.display = 'flex';
            
            // Check if user is admin
            await checkAdminStatus(user.uid);
            
            showPage('home-page');
            loadCodeFeed('first'); // Load halaman pertama
        } else {
            // Tidak ada user yang login
            currentUser = null;
            authButtons.style.display = 'flex';
            userMenu.style.display = 'none';
            profileNav.style.display = 'none';
            profileNavMobile.style.display = 'none';
            adminNav.style.display = 'none';
        }
    });
}

    // Handle authentication form submission
    async function handleAuthSubmit(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        try {
            if (isLoginMode) {
                // Login with email and password
                await auth.signInWithEmailAndPassword(email, password);
                showNotification('Berhasil masuk!', 'success');
            } else {
                // Sign up with email and password
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const name = email.split('@')[0];
                
                // Update profile dengan nama pengguna
                await userCredential.user.updateProfile({
                    displayName: name
                });
                
                // Create user profile di Firestore
                await db.collection('profiles').doc(userCredential.user.uid).set({
                    user_id: userCredential.user.uid,
                    display_name: name,
                    email: email,
                    avatar_url: '',
                    banner_url: '',
                    bio: '',
                    codes_shared: 0,
                    total_views: 0,
                    total_copies: 0,
                    is_verified: false,
                    is_admin: ADMIN_UIDS.includes(userCredential.user.uid),
                    created_at: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Akun berhasil dibuat!', 'success');
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    // Handle Google login
    async function handleGoogleLogin() {
        try {
            const provider = new firebase.auth.GoogleAuthProvider();
            const userCredential = await auth.signInWithPopup(provider);
            
            // Check if user profile exists, if not create one
            const profileDoc = await db.collection('profiles').doc(userCredential.user.uid).get();
            if (!profileDoc.exists) {
                await db.collection('profiles').doc(userCredential.user.uid).set({
                    user_id: userCredential.user.uid,
                    display_name: userCredential.user.displayName,
                    email: userCredential.user.email,
                    avatar_url: userCredential.user.photoURL || '',
                    banner_url: '',
                    bio: '',
                    codes_shared: 0,
                    total_views: 0,
                    total_copies: 0,
                    is_verified: false,
                    is_admin: ADMIN_UIDS.includes(userCredential.user.uid),
                    created_at: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    // Handle logout
    async function handleLogout() {
        try {
            await auth.signOut();
            showNotification('Berhasil keluar', 'success');
            showPage('auth-page');
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    // Update code preview
    function updateCodePreview() {
        const code = codeEditor.value;
        const language = codeLanguage.value;
        
        // Escape HTML sebelum ditampilkan
        const escapedCode = escapeHtml(code);
        
        codePreview.innerHTML = `<pre><code class="language-${language}">${escapedCode}</code></pre>`;
        
        // Apply syntax highlighting
        setTimeout(() => {
            const codeElement = codePreview.querySelector('code');
            if (codeElement) {
                hljs.highlightElement(codeElement);
            }
        }, 0);
    }

    // Handle publishing code
    async function handlePublishCode() {
        if (!currentUser) {
            showNotification('Silakan masuk untuk berbagi kode', 'info');
            showPage('auth-page');
            return;
        }
        
        const title = document.getElementById('code-title').value;
        const description = document.getElementById('code-description').value;
        const language = codeLanguage.value;
        const code = codeEditor.value;
        
        if (!title || !code) {
            showNotification('Judul dan kode tidak boleh kosong', 'error');
            return;
        }
        
        try {
            // Get user profile to check if verified
            const profileDoc = await db.collection('profiles').doc(currentUser.uid).get();
            const profile = profileDoc.data();
            
            const isVerified = profile ? profile.is_verified : false;
            
            // Add code to Firestore
            await db.collection('codes').add({
                title: title,
                description: description,
                language: language,
                code: code,
                author_id: currentUser.uid,
                author_name: currentUser.displayName || profile.display_name,
                author_avatar: profile.avatar_url || '',
                author_verified: isVerified,
                views: 0,
                copies: 0,
                created_at: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update user's codes shared count
            if (profile) {
                await db.collection('profiles').doc(currentUser.uid).update({
                    codes_shared: firebase.firestore.FieldValue.increment(1)
                });
            }
            
            // Reset form
            document.getElementById('code-title').value = '';
            document.getElementById('code-description').value = '';
            codeEditor.value = '';
            
            // Di fungsi handlePublishCode(), setelah berhasil publish:
showPage('home-page');
showNotification('Kode berhasil dibagikan!', 'success');
loadCodeFeed('first'); // Load halaman pertama
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

// Load code feed with pagination (FIXED: using Firebase cursor-based pagination)
async function loadCodeFeed(direction = 'first') {
    const codeFeed = document.getElementById('code-feed');
    codeFeed.innerHTML = '<div class="spinner"></div>';
    
    try {
        let query = db.collection('codes')
            .orderBy('created_at', 'desc')
            .limit(codesPerPage);
        
        // Handle pagination based on direction
        if (direction === 'next' && lastVisibleDoc) {
            query = query.startAfter(lastVisibleDoc);
        } else if (direction === 'prev' && firstVisibleDoc) {
            query = query.endBefore(firstVisibleDoc).limitToLast(codesPerPage);
        }
        
        const codesSnapshot = await query.get();
        
        codeFeed.innerHTML = '';
        
        if (codesSnapshot.empty) {
            codeFeed.innerHTML = '<p class="text-center">Belum ada kode yang dibagikan</p>';
            paginationContainer.innerHTML = '';
            return;
        }
        
        // Update pagination markers
        firstVisibleDoc = codesSnapshot.docs[0];
        lastVisibleDoc = codesSnapshot.docs[codesSnapshot.docs.length - 1];
        
        // Get total count for pagination info
        const countSnapshot = await db.collection('codes').get();
        totalCodes = countSnapshot.size;
        const totalPages = Math.ceil(totalCodes / codesPerPage);
        
        // Calculate current page
        if (direction === 'first') {
            currentPage = 1;
        } else if (direction === 'next') {
            currentPage++;
        } else if (direction === 'prev') {
            currentPage--;
        }
        
        codesSnapshot.forEach(doc => {
            const code = doc.data();
            const codeId = doc.id;
            
            // Escape semua data yang akan ditampilkan
            const safeTitle = escapeHtml(code.title);
            const safeDescription = code.description ? escapeHtml(code.description) : '';
            const safeCode = escapeHtml(code.code);
            const safeDisplayName = escapeHtml(code.author_name);
            
            const codeCard = document.createElement('div');
            codeCard.className = 'card code-card';
            codeCard.dataset.id = codeId;
            
            codeCard.innerHTML = `
                <div class="code-card-header">
                    <img src="${code.author_avatar || 'https://via.placeholder.com/40'}" alt="User Avatar" class="user-avatar" onerror="this.src='https://via.placeholder.com/40'">
                    <div class="user-info">
                        <div class="username">
                            <span>${safeDisplayName}</span>
                            ${code.author_verified ? '<span class="verified-badge">Terverifikasi</span>' : ''}
                        </div>
                        <span class="code-language">${escapeHtml(code.language)}</span>
                    </div>
                </div>
                
                <h3>${safeTitle}</h3>
                ${safeDescription ? `<p>${safeDescription}</p>` : ''}
                
                <div class="code-preview">
                    <pre><code class="language-${code.language}">${safeCode}</code></pre>
                </div>
                
                <div class="code-stats">
                    <div class="code-stat">
                        <i class="material-icons">visibility</i>
                        <span>${code.views || 0}</span>
                    </div>
                    <div class="code-stat">
                        <i class="material-icons">content_copy</i>
                        <span>${code.copies || 0}</span>
                    </div>
                </div>
            `;
            
            // Apply syntax highlighting
            setTimeout(() => {
                const codeElement = codeCard.querySelector('code');
                if (codeElement) {
                    hljs.highlightElement(codeElement);
                }
            }, 0);
            
            codeCard.addEventListener('click', () => {
                viewCode(codeId);
            });
            
            codeFeed.appendChild(codeCard);
        });
        
        // Add pagination buttons
        updatePaginationButtons(totalPages);
        
    } catch (error) {
        console.error('Error loading code feed:', error);
        codeFeed.innerHTML = '<p class="text-center">Gagal memuat kode</p>';
        showNotification('Gagal memuat kode: ' + error.message, 'error');
    }
}

    // Update pagination buttons
    // Update pagination buttons
// Update pagination buttons
function updatePaginationButtons(totalPages) {
    paginationContainer.innerHTML = '';
    
    if (totalPages <= 1) {
        return;
    }
    
    // Tombol Previous
    const prevBtn = document.createElement('button');
    prevBtn.className = 'pagination-btn';
    prevBtn.id = 'prev-page';
    prevBtn.innerHTML = '&laquo; Sebelumnya';
    prevBtn.disabled = currentPage <= 1;
    prevBtn.addEventListener('click', () => {
        loadCodeFeed('prev');
    });
    paginationContainer.appendChild(prevBtn);
    
    // Info halaman saat ini
    const pageInfo = document.createElement('span');
    pageInfo.className = 'page-info';
    pageInfo.textContent = ` Halaman ${currentPage} dari ${totalPages} `;
    paginationContainer.appendChild(pageInfo);
    
    // Tombol Next
    const nextBtn = document.createElement('button');
    nextBtn.className = 'pagination-btn';
    nextBtn.id = 'next-page';
    nextBtn.innerHTML = 'Selanjutnya &raquo;';
    nextBtn.disabled = currentPage >= totalPages;
    nextBtn.addEventListener('click', () => {
        loadCodeFeed('next');
    });
    paginationContainer.appendChild(nextBtn);
}

    // View a specific code
    async function viewCode(codeId) {
        currentViewingCodeId = codeId;
        
        try {
            // Get code data
            const codeDoc = await db.collection('codes').doc(codeId).get();
            
            if (!codeDoc.exists) {
                showNotification('Kode tidak ditemukan', 'error');
                return;
            }
            
            const code = codeDoc.data();
            
            // Update view count
            await db.collection('codes').doc(codeId).update({
                views: firebase.firestore.FieldValue.increment(1)
            });
            
            // Update user's total views if profile exists
            try {
                await db.collection('profiles').doc(code.author_id).update({
                    total_views: firebase.firestore.FieldValue.increment(1)
                });
            } catch (error) {
                console.error('Error updating profile views:', error);
            }
            
            // Escape semua data sebelum ditampilkan
            const safeTitle = escapeHtml(code.title);
            const safeDescription = code.description ? escapeHtml(code.description) : '';
            const safeCode = escapeHtml(code.code);
            const safeDisplayName = escapeHtml(code.author_name);
            
            // Update view page
            document.getElementById('view-author-avatar').src = code.author_avatar || 'https://via.placeholder.com/40';
            document.getElementById('view-author-avatar').onerror = function() {
                this.src = 'https://via.placeholder.com/40';
            };
            document.getElementById('view-author-name').textContent = safeDisplayName;
            
            if (code.author_verified) {
                document.getElementById('view-verified-badge').style.display = 'inline';
            } else {
                document.getElementById('view-verified-badge').style.display = 'none';
            }
            
            document.getElementById('view-code-language').textContent = code.language;
            document.getElementById('view-code-title').textContent = safeTitle;
            document.getElementById('view-code-description').textContent = safeDescription;
            document.getElementById('view-code-views').textContent = (code.views || 0) + 1;
            document.getElementById('view-code-copies').textContent = code.copies || 0;
            
            const codeContent = document.getElementById('view-code-content');
            codeContent.textContent = safeCode;
            codeContent.className = `language-${code.language}`;
            
            // Apply syntax highlighting
            setTimeout(() => {
                hljs.highlightElement(codeContent);
            }, 0);
            
            showPage('view-code-page');
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    // Handle copying code
    async function handleCopyCode() {
        const codeContent = document.getElementById('view-code-content').textContent;
        
        try {
            await navigator.clipboard.writeText(codeContent);
            
            // Update copy count
            await db.collection('codes').doc(currentViewingCodeId).update({
                copies: firebase.firestore.FieldValue.increment(1)
            });
            
            // Update user's total copies if profile exists
            try {
                const codeDoc = await db.collection('codes').doc(currentViewingCodeId).get();
                const code = codeDoc.data();
                
                await db.collection('profiles').doc(code.author_id).update({
                    total_copies: firebase.firestore.FieldValue.increment(1)
                });
            } catch (error) {
                console.error('Error updating profile copies:', error);
            }
            
            showNotification('Kode berhasil disalin!', 'success');
        } catch (error) {
            showNotification('Gagal menyalin kode', 'error');
        }
    }

    // Show share modal
    function showShareModal() {
        const currentUrl = window.location.origin + window.location.pathname + '?code=' + currentViewingCodeId;
        shareUrlInput.value = currentUrl;
        shareModal.style.display = 'flex';
    }

    // Share to specific platform
    function shareToPlatform(platform) {
        const url = encodeURIComponent(shareUrlInput.value);
        const title = encodeURIComponent(document.getElementById('view-code-title').textContent);
        
        let shareUrl = '';
        
        switch(platform) {
            case 'facebook':
                shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
                break;
            case 'twitter':
                shareUrl = `https://twitter.com/intent/tweet?text=${title}&url=${url}`;
                break;
            case 'whatsapp':
                shareUrl = `https://wa.me/?text=${title} ${url}`;
                break;
            case 'telegram':
                shareUrl = `https://t.me/share/url?url=${url}&text=${title}`;
                break;
            case 'linkedin':
                shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
                break;
            case 'copy':
                copyShareUrl();
                return;
            default:
                return;
        }
        
        window.open(shareUrl, '_blank');
    }

    // Copy share URL to clipboard
    async function copyShareUrl() {
        try {
            await navigator.clipboard.writeText(shareUrlInput.value);
            showNotification('Link berhasil disalin!', 'success');
        } catch (error) {
            showNotification('Gagal menyalin link', 'error');
        }
    }

    // Load user profile
    async function loadProfilePage(userId) {
        try {
            const profileDoc = await db.collection('profiles').doc(userId).get();
            
            if (!profileDoc.exists) {
                showNotification('Profil tidak ditemukan', 'error');
                return;
            }
            
            const userProfile = profileDoc.data();
            
            // Update profile page
            if (userProfile.banner_url) {
                document.getElementById('profile-banner').style.backgroundImage = `url(${userProfile.banner_url})`;
            } else {
                document.getElementById('profile-banner').style.backgroundImage = '';
                document.getElementById('profile-banner').style.backgroundColor = 'var(--primary-color)';
            }
            
            document.getElementById('profile-avatar').src = userProfile.avatar_url || 'https://via.placeholder.com/100';
            document.getElementById('profile-display-name').textContent = userProfile.display_name;
            document.getElementById('profile-bio').textContent = userProfile.bio || 'Tidak ada bio';
            document.getElementById('profile-codes-count').textContent = userProfile.codes_shared || 0;
            document.getElementById('profile-views-count').textContent = userProfile.total_views || 0;
            document.getElementById('profile-copies-count').textContent = userProfile.total_copies || 0;
            
            if (userProfile.is_verified) {
                document.getElementById('profile-verified-badge').style.display = 'inline';
            } else {
                document.getElementById('profile-verified-badge').style.display = 'none';
            }
            
            if (userProfile.is_admin) {
                document.getElementById('profile-admin-badge').style.display = 'inline';
            } else {
                document.getElementById('profile-admin-badge').style.display = 'none';
            }
            
            // Load user's codes (FIXED: removed orderBy to avoid composite index error)
            loadUserCodes(userId);
            
            // If it's the current user's profile, show edit button
            if (currentUser && currentUser.uid === userId) {
                const editButton = document.createElement('button');
                editButton.className = 'btn-outline comic-button';
                editButton.innerHTML = '<i class="material-icons">edit</i> Edit Profil';
                editButton.addEventListener('click', () => {
                    loadEditProfilePage();
                    showPage('edit-profile-page');
                });
                
                const profileInfo = document.querySelector('.profile-info');
                if (!document.getElementById('edit-profile-btn')) {
                    editButton.id = 'edit-profile-btn';
                    profileInfo.appendChild(editButton);
                }
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    // Load user's codes (FIXED: removed orderBy to avoid composite index error)
    async function loadUserCodes(userId) {
        const userCodesList = document.getElementById('user-codes-list');
        userCodesList.innerHTML = '<div class="spinner"></div>';
        
        try {
            // FIX: Removed orderBy to avoid composite index requirement
            const codesSnapshot = await db.collection('codes')
                .where('author_id', '==', userId)
                .get();
            
            userCodesList.innerHTML = '';
            
            if (codesSnapshot.empty) {
                userCodesList.innerHTML = '<p class="text-center">Belum ada kode yang dibagikan</p>';
                return;
            }
            
            // Convert to array and sort manually
            const codes = [];
            codesSnapshot.forEach(doc => {
                codes.push({ id: doc.id, ...doc.data() });
            });
            
            // Sort by date manually
            codes.sort((a, b) => {
                const dateA = a.created_at ? a.created_at.toDate() : new Date(0);
                const dateB = b.created_at ? b.created_at.toDate() : new Date(0);
                return dateB - dateA;
            });
            
            codes.forEach(code => {
                const codeId = code.id;
                
                // Escape semua data yang akan ditampilkan
                const safeTitle = escapeHtml(code.title);
                const safeDescription = code.description ? escapeHtml(code.description) : '';
                const safeCode = escapeHtml(code.code);
                
                const codeCard = document.createElement('div');
                codeCard.className = 'card code-card';
                codeCard.dataset.id = codeId;
                
                codeCard.innerHTML = `
                    <h3>${safeTitle}</h3>
                    ${safeDescription ? `<p>${safeDescription}</p>` : ''}
                    
                    <div class="code-preview">
                        <pre><code class="language-${code.language}">${safeCode}</code></pre>
                    </div>
                    
                    <div class="code-stats">
                        <div class="code-stat">
                            <i class="material-icons">visibility</i>
                            <span>${code.views || 0}</span>
                        </div>
                        <div class="code-stat">
                            <i class="material-icons">content_copy</i>
                            <span>${code.copies || 0}</span>
                        </div>
                    </div>
                `;
                
                // Apply syntax highlighting
                setTimeout(() => {
                    const codeElement = codeCard.querySelector('code');
                    if (codeElement) {
                        hljs.highlightElement(codeElement);
                    }
                }, 0);
                
                codeCard.addEventListener('click', () => {
                    viewCode(codeId);
                });
                
                userCodesList.appendChild(codeCard);
            });
        } catch (error) {
            userCodesList.innerHTML = '<p class="text-center">Gagal memuat kode</p>';
            showNotification(error.message, 'error');
        }
    }

    // Load edit profile page
    async function loadEditProfilePage() {
        try {
            const profileDoc = await db.collection('profiles').doc(currentUser.uid).get();
            
            if (!profileDoc.exists) {
                return;
            }
            
            const userProfile = profileDoc.data();
            
            // Pre-fill form fields
            document.getElementById('edit-display-name').value = userProfile.display_name || '';
            document.getElementById('edit-bio').value = userProfile.bio || '';
            
            avatarPreview.src = userProfile.avatar_url || 'https://via.placeholder.com/100';
            bannerPreview.src = userProfile.banner_url || 'https://via.placeholder.com/800x200';
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    // Handle image upload to GitHub
    async function handleImageUpload(file, type) {
        if (!file) return;
        
        // Validasi tipe file
        if (!file.type.match('image.*')) {
            showNotification('Hanya file gambar yang diizinkan', 'error');
            return;
        }
        
        // Validasi ukuran file (maksimal 5MB)
        if (file.size > 5 * 1024 * 1024) {
            showNotification('Ukuran file maksimal 5MB', 'error');
            return;
        }
        
        // PERBAIKAN: Menggunakan operator ternary yang benar
        const progressBar = type === 'avatar' ? avatarProgressBar : bannerProgressBar;
        const progressContainer = type === 'avatar' ? avatarProgress : bannerProgress;
        const preview = type === 'avatar' ? avatarPreview : bannerPreview;
        
        // Tampilkan progress bar
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        
        try {
            // Prepare the file content and path
            const fileName = generateFileName(file);
            const path = `${folderPath}/${fileName}`;
            
            // Read file as base64
            const base64Content = await readFileAsBase64(file);
            
            // Upload to GitHub
            const githubUrl = await uploadToGitHub(repo, branch, path, base64Content);
            
            // Update preview
            preview.src = githubUrl;
            
            // Sembunyikan progress bar
            progressContainer.style.display = 'none';
            
            showNotification('Gambar berhasil diunggah', 'success');
            
            // Simpan URL gambar ke state sementara untuk disimpan nanti
            preview.dataset.uploadedUrl = githubUrl;
            
        } catch (error) {
            progressContainer.style.display = 'none';
            showNotification('Gagal mengunggah gambar: ' + error.message, 'error');
        }
    }

    // Generate a unique file name
    function generateFileName(file) {
        const extension = file.name.split('.').pop();
        const timestamp = new Date().getTime();
        const randomString = Math.random().toString(36).substring(2, 8);
        return `image-${timestamp}-${randomString}.${extension}`;
    }
    
    // Read file as base64
    function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        });
    }
    
    // Upload to GitHub
    async function uploadToGitHub(repo, branch, path, content) {
        const apiUrl = `https://api.github.com/repos/${githubUsername}/${repo}/contents/${path}`;
        
        const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${githubToken}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: `Upload image: ${path}`,
                content: content,
                branch: branch
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Gagal mengupload ke GitHub');
        }
        
        // Return the raw content URL
        return `https://raw.githubusercontent.com/${githubUsername}/${repo}/${branch}/${path}`;
    }

    // Handle saving profile
    async function handleSaveProfile() {
        const displayName = document.getElementById('edit-display-name').value;
        const bio = document.getElementById('edit-bio').value;
        
        // Validasi input
        if (!displayName.trim()) {
            showNotification('Nama tampilan tidak boleh kosong', 'error');
            return;
        }
        
        try {
            const updates = {
                display_name: displayName.trim(),
                bio: bio.trim(),
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Jika ada avatar yang diunggah, tambahkan ke updates
            if (avatarPreview.dataset.uploadedUrl) {
                updates.avatar_url = avatarPreview.dataset.uploadedUrl;
            }
            
            // Jika ada banner yang diunggah, tambahkan ke updates
            if (bannerPreview.dataset.uploadedUrl) {
                updates.banner_url = bannerPreview.dataset.uploadedUrl;
            }
            
            showNotification('Menyimpan profil...', 'info');
            
            await db.collection('profiles').doc(currentUser.uid).update(updates);
            
            showNotification('Profil berhasil diperbarui!', 'success');
            
            // Tunggu sebentar sebelum redirect
            setTimeout(() => {
                loadProfilePage(currentUser.uid);
                showPage('profile-page');
            }, 1000);
        } catch (error) {
            console.error('Error saving profile:', error);
            showNotification('Gagal menyimpan profil: ' + error.message, 'error');
        }
    }

    // Handle search
    async function handleSearch() {
        const query = searchInput.value.trim().toLowerCase();
        if (!query) return;
        
        searchResults.innerHTML = '<div class="spinner"></div>';
        
        try {
            const codesSnapshot = await db.collection('codes').get();
            
            searchResults.innerHTML = '';
            
            if (codesSnapshot.empty) {
                searchResults.innerHTML = '<p class="text-center">Tidak ada hasil ditemukan</p>';
                return;
            }
            
            let foundResults = false;
            
            codesSnapshot.forEach(doc => {
                const code = doc.data();
                const codeId = doc.id;
                
                // Check if code matches search query
                if (
                    code.title.toLowerCase().includes(query) ||
                    code.language.toLowerCase().includes(query) ||
                    (code.description && code.description.toLowerCase().includes(query))
                ) {
                    foundResults = true;
                    
                    // Escape semua data yang akan ditampilkan
                    const safeTitle = escapeHtml(code.title);
                    const safeDescription = code.description ? escapeHtml(code.description) : '';
                    const safeCode = escapeHtml(code.code);
                    const safeDisplayName = escapeHtml(code.author_name);
                    
                    const codeCard = document.createElement('div');
                    codeCard.className = 'card code-card';
                    codeCard.dataset.id = codeId;
                    
                    codeCard.innerHTML = `
                        <div class="code-card-header">
                            <img src="${code.author_avatar || 'https://via.placeholder.com/40'}" alt="User Avatar" class="user-avatar" onerror="this.src='https://via.placeholder.com/40'">
                            <div class="user-info">
                                <div class="username">
                                    <span>${safeDisplayName}</span>
                                    ${code.author_verified ? '<span class="verified-badge">Terverifikasi</span>' : ''}
                                </div>
                                <span class="code-language">${escapeHtml(code.language)}</span>
                            </div>
                        </div>
                        
                        <h3>${safeTitle}</h3>
                        ${safeDescription ? `<p>${safeDescription}</p>` : ''}
                        
                        <div class="code-preview">
                            <pre><code class="language-${code.language}">${safeCode}</code></pre>
                        </div>
                        
                        <div class="code-stats">
                            <div class="code-stat">
                                <i class="material-icons">visibility</i>
                                <span>${code.views || 0}</span>
                            </div>
                            <div class="code-stat">
                                <i class="material-icons">content_copy</i>
                                <span>${code.copies || 0}</span>
                            </div>
                        </div>
                    `;
                    
                    // Apply syntax highlighting
                    setTimeout(() => {
                        const codeElement = codeCard.querySelector('code');
                        if (codeElement) {
                            hljs.highlightElement(codeElement);
                        }
                    }, 0);
                    
                    codeCard.addEventListener('click', () => {
                        viewCode(codeId);
                    });
                    
                    searchResults.appendChild(codeCard);
                }
            });
            
            if (!foundResults) {
                searchResults.innerHTML = '<p class="text-center">Tidak ada hasil ditemukan</p>';
            }
        } catch (error) {
            searchResults.innerHTML = '<p class="text-center">Gagal melakukan pencarian</p>';
            showNotification(error.message, 'error');
        }
    }

    // Load admin stats
    async function loadAdminStats() {
        try {
            // Get total users
            const usersSnapshot = await db.collection('profiles').get();
            adminStats.totalUsers = usersSnapshot.size;
            
            // Get total codes
            const codesSnapshot = await db.collection('codes').get();
            adminStats.totalCodes = codesSnapshot.size;
            
            // Get today's codes
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let todayCodes = 0;
            codesSnapshot.forEach(doc => {
                const code = doc.data();
                const codeDate = code.created_at ? code.created_at.toDate() : new Date();
                if (codeDate >= today) {
                    todayCodes++;
                }
            });
            adminStats.todayCodes = todayCodes;
            
            // Get total views
            let totalViews = 0;
            codesSnapshot.forEach(doc => {
                const code = doc.data();
                totalViews += code.views || 0;
            });
            adminStats.totalViews = totalViews;
            
            // Update UI
            document.getElementById('admin-total-users').textContent = adminStats.totalUsers;
            document.getElementById('admin-total-codes').textContent = adminStats.totalCodes;
            document.getElementById('admin-today-codes').textContent = adminStats.todayCodes;
            document.getElementById('admin-total-views').textContent = adminStats.totalViews;
            
        } catch (error) {
            console.error('Error loading admin stats:', error);
            showNotification('Gagal memuat statistik admin', 'error');
        }
    }

    // Handle user search (admin)
    async function handleUserSearch() {
        const query = userSearch.value.trim().toLowerCase();
        if (!query) return;
        
        userSearchResults.innerHTML = '<div class="spinner"></div>';
        
        try {
            const usersSnapshot = await db.collection('profiles').get();
            
            userSearchResults.innerHTML = '';
            
            if (usersSnapshot.empty) {
                userSearchResults.innerHTML = '<p class="text-center">Tidak ada pengguna ditemukan</p>';
                return;
            }
            
            let foundResults = false;
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                const userId = doc.id;
                
                // Check if user matches search query
                if (
                    user.display_name.toLowerCase().includes(query) ||
                    user.email.toLowerCase().includes(query)
                ) {
                    foundResults = true;
                    
                    const userCard = document.createElement('div');
                    userCard.className = 'card';
                    userCard.innerHTML = `
                        <div class="code-card-header">
                            <img src="${user.avatar_url || 'https://via.placeholder.com/40'}" alt="User Avatar" class="user-avatar" onerror="this.src='https://via.placeholder.com/40'">
                            <div class="user-info">
                                <div class="username">
                                    <span>${escapeHtml(user.display_name)}</span>
                                    ${user.is_verified ? '<span class="verified-badge">Terverifikasi</span>' : ''}
                                    ${user.is_admin ? '<span class="admin-badge">Admin</span>' : ''}
                                </div>
                                <div>Email: ${user.email}</div>
                            </div>
                        </div>
                        
                        <div class="profile-stats">
                            <div class="profile-stat">
                                <div class="stat-value">${user.codes_shared || 0}</div>
                                <div class="stat-label">Kode Dibagikan</div>
                            </div>
                            <div class="profile-stat">
                                <div class="stat-value">${user.total_views || 0}</div>
                                <div class="stat-label">Total Dilihat</div>
                            </div>
                            <div class="profile-stat">
                                <div class="stat-value">${user.total_copies || 0}</div>
                                <div class="stat-label">Total Disalin</div>
                            </div>
                        </div>
                        
                        ${!user.is_verified ? `
                            <button class="btn-primary comic-button verify-user-btn" data-userid="${userId}">
                                Verifikasi Pengguna
                            </button>
                        ` : ''}
                        
                        ${user.is_verified ? `
                            <button class="btn-danger comic-button unverify-user-btn" data-userid="${userId}">
                                Batalkan Verifikasi
                            </button>
                        ` : ''}
                    `;
                    
                    userSearchResults.appendChild(userCard);
                }
            });
            
            if (!foundResults) {
                userSearchResults.innerHTML = '<p class="text-center">Tidak ada pengguna ditemukan</p>';
            } else {
                // Add event listeners to verify buttons
                document.querySelectorAll('.verify-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.dataset.userid;
                        verifyUser(userId, true);
                    });
                });
                
                // Add event listeners to unverify buttons
                document.querySelectorAll('.unverify-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.dataset.userid;
                        verifyUser(userId, false);
                    });
                });
            }
        } catch (error) {
            userSearchResults.innerHTML = '<p class="text-center">Gagal melakukan pencarian</p>';
            showNotification(error.message, 'error');
        }
    }

    // Verify user (admin only)
    async function verifyUser(userId, verify) {
        try {
            await db.collection('profiles').doc(userId).update({
                is_verified: verify
            });
            
            // Also update all user's codes
            const userCodesSnapshot = await db.collection('codes')
                .where('author_id', '==', userId)
                .get();
            
            const batch = db.batch();
            
            userCodesSnapshot.forEach(doc => {
                const codeRef = db.collection('codes').doc(doc.id);
                batch.update(codeRef, { author_verified: verify });
            });
            
            await batch.commit();
            
            showNotification(`Pengguna berhasil ${verify ? 'diverifikasi' : 'dibatalkan verifikasinya'}`, 'success');
            handleUserSearch(); // Refresh search results
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    // Load leaderboard
    async function loadLeaderboard() {
        const leaderboardList = document.getElementById('leaderboard-list');
        leaderboardList.innerHTML = '<div class="spinner"></div>';
        
        try {
            const usersSnapshot = await db.collection('profiles')
                .orderBy('codes_shared', 'desc')
                .limit(10)
                .get();
            
            leaderboardList.innerHTML = '';
            
            if (usersSnapshot.empty) {
                leaderboardList.innerHTML = '<p class="text-center">Belum ada data leaderboard</p>';
                return;
            }
            
            let rank = 1;
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                
                const leaderboardItem = document.createElement('div');
                leaderboardItem.className = 'leaderboard-item';
                
                leaderboardItem.innerHTML = `
                    <div class="leaderboard-rank">${rank}</div>
                    <div class="leaderboard-user">
                        <img src="${user.avatar_url || 'https://via.placeholder.com/40'}" alt="User Avatar" class="leaderboard-avatar" onerror="this.src='https://via.placeholder.com/40'">
                        <div>
                            <div class="username">
                                <span>${escapeHtml(user.display_name)}</span>
                                ${user.is_verified ? '<span class="verified-badge">Terverifikasi</span>' : ''}
                                ${user.is_admin ? '<span class="admin-badge">Admin</span>' : ''}
                            </div>
                        </div>
                        </div>
                        <div class="leaderboard-value">${user.codes_shared || 0} kode</div>
                    `;
                    
                    leaderboardList.appendChild(leaderboardItem);
                    rank++;
                });
            } catch (error) {
                leaderboardList.innerHTML = '<p class="text-center">Gagal memuat leaderboard</p>';
                showNotification(error.message, 'error');
            }
        }

        // Check if user is admin
        async function checkAdminStatus(userId) {
            try {
                const profileDoc = await db.collection('profiles').doc(userId).get();
                
                if (profileDoc.exists && profileDoc.data().is_admin) {
                    adminNav.style.display = 'flex';
                }
            } catch (error) {
                console.error('Error checking admin status:', error);
            }
        }

        // Utility functions
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
               
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            let icon = 'info';
            if (type === 'success') icon = 'check_circle';
            if (type === 'error') icon = 'error';
            if (type === 'warning') icon = 'warning';
            
            notification.innerHTML = `
                <i class="material-icons">${icon}</i>
                <span>${message}</span>
            `;
            
            document.getElementById('notification-container').appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
